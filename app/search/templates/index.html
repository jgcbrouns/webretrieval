<!DOCTYPE HTML>
<html lang="en">
   <head>
      <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <![endif]-->
      <meta charset="utf-8">
      <title>Web Retrieval Project Website</title>
      <meta name="description" content="A Webapplication made for the Web Retrieval Course of the TU/e">
      <meta property="og:image" content="https://www.3dprintingclub.nl/wp-content/uploads/2017/01/tu-eindhoven.png" />
      <meta name="viewport" content="width=device-width">
      <link rel="shortcut icon" href="favicon.ico">
      {% load staticfiles %}
      <link rel="stylesheet" href="{% static 'search/stretchy-navigation/css/style.css' %}">
      <link rel="stylesheet" href="{% static 'search/stretchy-navigation/css/reset.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/settings-button.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/selectbox.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/styles.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/fancyInput.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/bootstrap.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/spinner.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/toggle.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/fancyTable.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/main.css' %}">
  
      <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
      <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
      <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
      <script src="{% static 'search/stretchy-navigation/js/main.js' %}"></script>
      <script src="{% static 'search/stretchy-navigation/js/modernizr.js' %}"></script>
   </head>
   <body>
      <div class="settingsButton">
         <i class="fa fa-cog fa-5x" aria-hidden="true" data-toggle="collapse" data-target="#demo"></i>
      </div>
      <!--  <form method="get" action="/"> -->
      <div class="inputContainer">
         <section class='input'>
            <div>
               <input type='text' autocomplete="off" placeholder='' name="q" id="id_q" value="{{ query }}">
            </div>
         </section>
      </div>

     <div class="container">
        <div id="demo" class="collapse">
           <h4>Search on field:</h4>
           <div class="select">
              <select name="slct" id="slct">
                 <option value="title" selected>Title</option>
                 <option value="paper_text">Document content</option>
              </select>
           </div>
           <div>
              <h4>Reindex:</h4>
              <span class="checkbox">
              <input type="checkbox" id="reindexField">
              <label data-on="ON" data-off="OFF"></label>
              </span>
           </div>
        </div>
     </div>
      <!--  </form> -->
      <nav class="cd-stretchy-nav">
         <a class="cd-nav-trigger" href="#0">
         <span aria-hidden="true"></span>
         </a>
         <ul>
            <li><a href="/" class="active"><span>Search</span></a></li>
            <li><a href="/clusters"><span>Clusters</span></a></li>
            <li><a href="/Topics"><span>Topics</span></a></li>
         </ul>
         <span aria-hidden="true" class="stretchy-nav-bg"></span>
      </nav>
      <div class="tableContainer">
         <div class="loader">
            <h1>LOADING</h1>
            <span></span>
            <span></span>
            <span></span>
         </div>
         <!-- Div for display errors -->
         <div id="results"></div>
         <div id="noResultBlock" style="color: #FFF">
            There were no results.
         </div>
         <div id="tablePart">
            <h1>Results:</h1>
            <div class="tbl-header">
               <table cellpadding="0" cellspacing="0" border="0">
                  <thead>
                     <tr>
                        <th width="65%">Papers</th>
                        <th>Year</th>
                        <th>PageRank</th>
                     </tr>
                  </thead>
               </table>
            </div>
            <div class="tbl-content">
               <table cellpadding="0" cellspacing="0" border="0" id="resultTable">
                  <tbody>
                  </tbody>
               </table>
            </div>
         </div>
      </div>
      <!--  -->
      <a class='git' title='TUE' href='https://tue.nl'><img width="150px" src="{% static 'search/images/tuelogo.png' %}"></a>
      <script src='{% static 'search/css/fancyInput.js' %}'></script>
      <script>
         var currentXhr;
         
         $('section :input').val('').fancyInput()[0].focus();
         
         //For the table
         $(window).on("load resize ", function() {
           var scrollWidth = $('.tbl-content').width() - $('.tbl-content table').width();
           $('.tbl-header').css({'padding-right':scrollWidth});
         }).resize();
         
         init();
         
         function loadingOn()
         {
            $('#tablePart').hide();
            $('#resultTable').hide();
            $('.loader').show();
            hideNoResultBlock();
         }
         
         function init(){
          $('#tablePart').hide();
          $('.loader').hide();
          hideNoResultBlock();
         }
         
         function hideNoResultBlock()
         {
          $('#noResultBlock').hide();
         }
         
         function showNoResultMessage()
         {
            $('#tablePart').hide();
            $('#resultTable').hide();
            $('.loader').hide();  
            $('#noResultBlock').show();     
         }
         
         function loadingOffAndShowResult()
         {
          $('#noResultBlock').hide(); 
          $('#tablePart').delay(1000).show();
          $('#resultTable').show(500);
            $('.loader').hide();  
         }
         
         $("#id_q").on('input', function() {
         var value=$.trim($("#id_q").val());
         if(value.length>0)
         {
         loadingOn();
              event.preventDefault();
              create_post();
          }
          //field is empty so dont query and show no result
          else
          {
            showNoResultMessage();
          }
         
         });
         
         // AJAX for posting
         function create_post() {

         settings = getSettings();
         
         currentXhr && currentXhr.readyState != 4 && currentXhr.abort(); // clear previous request
         
         console.log('making request')
         xhr = $.ajax({
          url : "/getContent/", // the endpoint
          type : "POST", // http method
          data : { query : $('#id_q').val(), field : settings['field'], reindex : settings['reindex'] }, // data sent with the post request
         
          // handle a successful response
          success : function(json) {
         
            //console.log(json.papers);
              if(json.papers == "[]")
              {
                 console.log("yes");
                 setTimeout(showNoResultMessage, 700)
              }
              else
              {
                hideNoResultBlock();
               updateDom(json.papers);
               setTimeout(loadingOffAndShowResult, 500)
              }
         
          },
         
          // handle a non-successful response
          error : function(xhr,errmsg,err) {
            loadingOff();
              $('#results').html("<div class='alert-box alert radius' style='margin-top:20px; color: #FFF' data-alert>Oops! We have encountered an error: "+errmsg+
                  " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
         });
         };
         
         function updateDom(data)
         {
         //Remove potentially previous rows from the table
         $("#resultTable > tbody").html("");
         
         $.each(JSON.parse(data), function(idx, obj) {
         title = obj.title;
         year = obj.year;
         id = obj.id;
         pagerank = obj.pagerank;
         addRowToTable(title, year, pagerank, id);
         });
         
         
         }
         
         function getSettings()
         {
            var field = $('#slct option:selected').val();
            var reindex = $("#reindexField").is(":checked");

            var settings = [];
            settings['field'] = field;
            settings['reindex'] = reindex;

            return settings;
         }

         function addRowToTable(title, year, pagerank, id)
         {
         
         if(typeof pagerank == 'undefined')
         {
         pagerank = '/';
         }
         
         $('#resultTable > tbody:last-child').append(
               '<tr>'// need to change closing tag to an opening `<tr>` tag.
                +'<td width="65%">' 
                      + '<a href="' + 'paper?id=' + id + '">'+ title + '</a>' 
                    + '</td>'
                +'<td>'+ year +'</td>'
                    +'<td>'+ pagerank +'</td>'
               +'</tr>');
         }
         
      </script>
      <script src="{% static 'search/js/selectbox.js' %}"></script>
   </body>
</html>