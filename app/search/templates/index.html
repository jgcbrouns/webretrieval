<!DOCTYPE HTML>
<html lang="en">
   <head>
      <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <![endif]-->
      <meta charset="utf-8">
      <title>Web Retrieval Project Website</title>
      <meta name="description" content="A Webapplication made for the Web Retrieval Course of the TU/e">
      <meta property="og:image" content="https://www.3dprintingclub.nl/wp-content/uploads/2017/01/tu-eindhoven.png" />
      <meta name="viewport" content="width=device-width">
      <link rel="shortcut icon" href="favicon.ico">
      {% load staticfiles %}
      <link rel="stylesheet" href="{% static 'search/stretchy-navigation/css/style.css' %}">
      <link rel="stylesheet" href="{% static 'search/stretchy-navigation/css/reset.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/settings-button.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/selectbox.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/styles.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/fancyInput.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/slider.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/bootstrap.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/spinner.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/toggle.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/fancyTable.css' %}">
      <link rel="stylesheet" href="{% static 'search/css/main.css' %}">
  
      <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
      <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
      <script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
      <script src="{% static 'search/stretchy-navigation/js/main.js' %}"></script>
      <script src="{% static 'search/stretchy-navigation/js/modernizr.js' %}"></script>
   </head>
   <body>

    <div class="logo">
      <img width="180px" src="{% static 'search/images/logo.png' %}">
    </div>

      <!--  <form method="get" action="/"> -->
      <div class="inputContainer">
         <section class='input'>
            <div>
               <input type='text' autocomplete="off" placeholder='' name="q" id="id_q" value="{{ query }}">
            </div>
         </section>
      </div>

     <div class="container">
        <div id="demo" class="collapse">
           <h4>Search on field:</h4>
           <div class="select">
              <select name="slct" id="slct">
                 <option value="title" selected>Title</option>
                 <option value="paper_text">Document content</option>
              </select>
           </div>
           <h4>Search on year:</h4>
           <div class="select">
              <select name="slct_year" id="slct_year">
                  <option value="0" selected>All years</option>
                  <option value="2016">2016</option>
                  <option value="2015">2015</option>
                  <option value="2014">2014</option>
                  <option value="2013">2013</option>
                  <option value="2012">2012</option>
                  <option value="2011">2011</option>
                  <option value="2010">2010</option>
                  <option value="2009">2009</option>
                  <option value="2008">2008</option>
                  <option value="2007">2007</option>
                  <option value="2006">2006</option>
                  <option value="2005">2005</option>
                  <option value="2004">2004</option>
                  <option value="2003">2003</option>
                  <option value="2002">2002</option>
                  <option value="2001">2001</option>
                  <option value="2000">2000</option>
                  <option value="1999">1999</option>
                  <option value="1998">1998</option>
                  <option value="1997">1997</option>
                  <option value="1996">1996</option>
                  <option value="1995">1995</option>
                  <option value="1994">1994</option>
                  <option value="1993">1993</option>
                  <option value="1992">1992</option>
                  <option value="1991">1991</option>
                  <option value="1990">1990</option>
                  <option value="1989">1989</option>
                  <option value="1988">1988</option>
                  <option value="1987">1987</option>
              </select>
           </div>
           <div>
              <h4>Reindex:</h4>
              <span class="checkbox">
              <input type="checkbox" id="reindexField">
              <label data-on="ON" data-off="OFF"></label>
              </span>
           </div>
<!--            <div>
              <h4>References PageRank:</h4>
              <span class="checkbox">
              <input type="checkbox" id="referencePageRankField">
              <label data-on="ON" data-off="OFF"></label>
              </span>
           </div> -->
           <div>
              <h4>VSR Threshold-value:</h4>
              <div class="range-slider">
                <input class="range-slider__range" type="range" value="0" min="0" max="1" step="0.01">
                <span class="range-slider__value">0</span>
              </div>
           </div>
        </div>
     </div>
      <!--  </form> -->
      <nav class="cd-stretchy-nav">
         <a class="cd-nav-trigger" href="#0">
         <span aria-hidden="true"></span>
         </a>
         <ul>
            <li><a href="/" class="active"><span>Search</span></a></li>
            <li><a href="/clusters"><span>Clusters</span></a></li>
            <li><a href="/Topics"><span>Topics</span></a></li>
         </ul>
         <span aria-hidden="true" class="stretchy-nav-bg"></span>
      </nav>
      <div class="tableContainer">
         <div class="loader">
            <h1>LOADING</h1>
            <span></span>
            <span></span>
            <span></span>
         </div>
         <!-- Div for display errors -->
         <div id="results"></div>
         <div id="noResultBlock" style="color: #FFF">
            There were no results.
         </div>
         <div id="tablePart">
            <h1>Results:</h1>
            <div class="tbl-header">
               <table cellpadding="0" cellspacing="0" border="0">
                  <thead>
                     <tr>
                        <th width="65%">Papers</th>
                        <th>Year</th>
                        <th>PageRank</th>
                     </tr>
                  </thead>
               </table>
            </div>
            <div class="tbl-content">
               <table cellpadding="0" cellspacing="0" border="0" id="resultTable">
                  <tbody>
                  </tbody>
               </table>
            </div>
         </div>
      </div>

            <div class="settingsButton">
         <i class="fa fa-cog fa-5x" aria-hidden="true" data-toggle="collapse" data-target="#demo"></i>
      </div>
      <!--  -->
      <a class='git' title='TUE' href='https://tue.nl'><img width="150px" src="{% static 'search/images/tuelogo.png' %}"></a>
      <script src='{% static 'search/css/fancyInput.js' %}'></script>
      <script>
       var currentXhr;

       $('section :input').val('').fancyInput()[0].focus();

       //For the table
       $(window).on("load resize ", function() {
           var scrollWidth = $('.tbl-content').width() - $('.tbl-content table').width();
           $('.tbl-header').css({
               'padding-right': scrollWidth
           });
       }).resize();

       init();

       function loadingOn() {
           $('#tablePart').hide();
           $('#resultTable').hide();
           $('.loader').show();
           hideNoResultBlock();
       }

       function init() {
           $('#tablePart').hide();
           $('.loader').hide();
           hideNoResultBlock();
       }

       function hideNoResultBlock() {
           $('#noResultBlock').hide();
       }

       function showNoResultMessage() {
           $('#tablePart').hide();
           $('#resultTable').hide();
           $('.loader').hide();
           $('#noResultBlock').show();
       }

       function loadingOffAndShowResult() {
           $('#tablePart').show();
           $('#resultTable').show();
           $('.loader').hide();
           hideNoResultBlock();
       }

       $("#id_q").on('input', function() {
           prepareRequest()
       });

       $("#slct").on('change', function() {
           prepareRequest()
       });

       $("#thresholdvalueField").on('change', function() {
           prepareRequest()
       });

       $("#slct_year").on('change', function() {
           prepareRequest()
       });

       // $("#referencePageRankField").on('change', function() {
       //    prepareRequest()
       // });

       $("#reindexField").on('change', function() {
           prepareRequest()
       });

       function prepareRequest() {
           var value = $.trim($("#id_q").val());
           if (value.length > 0) {
               loadingOn();
               event.preventDefault();
               create_post();
           }
           //field is empty so dont query and show no result
           // else
           // {
           //   showNoResultMessage();
           // }
       }

       // AJAX for posting
       function create_post() {

           settings = getSettings();

           currentXhr && currentXhr.readyState != 4 && currentXhr.abort(); // clear previous request

           console.log('making request')
           xhr = $.ajax({
               url: "/getContent/", // the endpoint
               type: "POST", // http method
               data: {
                   query: $('#id_q').val(),
                   field: settings['field'],
                   reindex: settings['reindex'],
                   usepagerank: settings['referencePageRankField'],
                   threshold: settings['threshold'],
                   year: settings['year']
               }, // data sent with the post request

               // handle a successful response
               success: function(json) {

                   var status = json.status;
                   var usepagerank = json.usepagerank;
                   var papers = json.papers;

                   //console.log(json.papers);
                   if(status=="done")
                   {
                       if (papers == "[]") {
                           console.log("yes");
                           showNoResultMessage()
                       } else {
                           updateDom(json.papers);
                           loadingOffAndShowResult();
                       }
                   }

               },

               // handle a non-successful response
               error: function(xhr, errmsg, err) {
                   loadingOff();
                   $('#results').html("<div class='alert-box alert radius' style='margin-top:20px; color: #FFF' data-alert>Oops! We have encountered an error: " + errmsg +
                       " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                   console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
               }
           });
       };

$( document ).ajaxStop(function() {
  console.log( "Triggered ajaxStop handler." );
});

                  // .done(function(json) {
           //     var usepagerank = json.usepagerank;

           //     //console.log(json.papers);
           //     if (json.papers == "[]") {
           //         console.log("yes");
           //         showNoResultMessage();
           //     } else {
           //         updateDom(json.papers);
           //         loadingOffAndShowResult();
           //     }
           //  });

       function updateDom(data) {
           //Remove potentially previous rows from the table
           $("#resultTable > tbody").html("");

           $.each(JSON.parse(data), function(idx, obj) {
               title = obj.title;
               year = obj.year;
               id = obj.id;
               pagerank = obj.pagerank;
               addRowToTable(title, year, pagerank, id);
           });
       }

       function getSettings() {
           var field = $('#slct option:selected').val();
           var threshold = $('.range-slider__value').html();
           var reindex = $("#reindexField").is(":checked");
           var referencePageRankField = $("#referencePageRankField").is(":checked");
           var year = $('#slct_year option:selected').val();

           var settings = [];
           settings['field'] = field;
           settings['reindex'] = reindex;
           settings['referencePageRankField'] = referencePageRankField;
           settings['threshold'] = threshold;
           settings['year'] = year;
           console.log(settings);
           return settings;
       }

       function addRowToTable(title, year, pagerank, id) {

           if (typeof pagerank == 'undefined') {
               pagerank = '/';
           }

           $('#resultTable > tbody:last-child').append(
               '<tr>' // need to change closing tag to an opening `<tr>` tag.
               +
               '<td width="65%">' +
               '<a href="' + 'paper?id=' + id + '" target="_blank">' + title + '</a>' +
               '</td>' +
               '<td>' + year + '</td>' +
               '<td>' + pagerank + '</td>' +
               '</tr>');
       }

       var rangeSlider = function() {
           var slider = $('.range-slider'),
               range = $('.range-slider__range'),
               value = $('.range-slider__value');

           slider.each(function() {
               value.each(function() {
                   var value = $(this).prev().attr('value');
                   $(this).html(value / 100);
               });

               range.on('input', function() {
                   $(this).next(value / 100).html(this.value);
               });

               range.on('change', function() {
                   prepareRequest();
               });
           });
       };

       rangeSlider();
      </script>
      <script src="{% static 'search/js/selectbox.js' %}"></script>
   </body>
</html>